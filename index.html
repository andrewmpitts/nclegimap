<html>
<head>
    <title>NC General Assembly Map</title>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="representatives/ncCongressReps.js"></script>
    <link rel="stylesheet" type="text/css" href="style/generalStyle.css">
</head>
<body>
<div class = "mapNavbar">
    <span id = "repMapToggle" class = "mapToggle" onclick = "toggleMap('rep')">NC House of Representatives Districts</span>
    <span id = "senMapToggle" class = "mapToggle" onclick = "toggleMap('sen')">NC Senate Districts</span>
    <span id = "congressMapToggle" class = "mapToggle" onclick = "toggleMap('con')">NC Congressional Districts</span>
    <!--<span id = "dcSenMapToggle"></span>-->
</div>
<hr>
<div class = "contentWrapper">
    <div class = "mapContainer">
        <svg id="map" width="900" height="450" style="border: 1px solid black;"></svg>
        <div class = "mapContextContainer" style = "left: 900px; top: 0px; width: 300px; height: 450px; display: inline-block; border-right-width: 1px; border-right-color: black; border-right-style: solid; border-top-width: 1px; border-top-color: black; border-top-style: solid; border-bottom-width: 1px; border-bottom-color: black; border-bottom-style: solid; float: right;">
            <h3 id = "legTitle">Representative</h3>
            <p class="repName" id="repNameText" style="text-align: center; margin: auto; padding: 5px; width: 100%;">Representative Name</p>
            <hr>

            <div class="photoContainer">
                <img id = "repPhoto" class = "photo">
                <br>
                <span id="districtText" class="infoText"></span>
                <span><a id = "partyText"></a></span>
            </div>
            <div class="infoContainer">

                <!--<p id="partyText" class="infoText"></p>-->
                <!--<a id="nclegURLText" class="infoText"></a>-->
                <!--<a id="emailLink" class="infoText"></a>-->
            </div>
            <!--<div class="addressContainer">-->
                <!--<div class = "leftAddressContainer">-->
                    <!--<p id = "localAddress" class = "localAddress address"></p>-->
                <!--</div>-->
                <!--<div class = "rightAddressContainer">-->
                    <!--<p id = "capitalAddress" class = "capitalAddress address"></p>-->
                <!--</div>-->
            <!--</div>-->
        </div>
    </div>
    <div id = "bottomInfoContainer" class = "bottomInfoContainer">
        <h3 id = "addressHeader">Addresses</h3>
        <div id="capitolAddressContainer">
            <div class = "rightAddressContainer">
                <p id = "capitalAddress" class = "capitalAddress address">Raleigh Address</p>
            </div>
        </div>
        <div id="localAddressContainer" class="addressContainer">

            <div class = "leftAddressContainer">
                <p id = "localAddress" class = "localAddress address">Local Address</p>
            </div>

        </div>

        <div id = "linkContainer">
            <ul>
                <li><a id = "nclegURLText"></a></li>
                <li>Email: <a id = "emailLink"></a></li>

            </ul>

        </div>
    </div>
</div>
<script>
    var openStatesURL = "https://openstates.org/api/v1/METHOD/";
    var ncMetadataURL = "openstates.org/api/v1/metadata/nc/";
    var ncLegislatorsURL = "https://openstates.org/api/v1/legislators/?state=nc";
    var ncSenateURL = "https://openstates.org/api/v1/legislators/?state=nc&chamber=upper";
    var ncRepURL = "https://openstates.org/api/v1/legislators/?state=nc&chamber=lower";
    var billLookupURL = "https://openstates.org/api/v1/bills/NCB00010747/";
    var hb2BillURL = "https://openstates.org/api/v1/bills/NCB00009985/"; //Detailed bill example
    var billLookupURL = "openstates.org/api/v1/bills/?state=nc&q=" //+ query
    var ncCongressURL = "http://apitts.com/"
    var billIds = [];

    var repModel = {};
    var senModel = {};
    var conModel = {};

    var width = 900, height = 450;

    var svgSenMap = d3.select( "body" )
            .append( "svg" )
            .attr( "id", "ncSenMap")
            .attr( "width", width )
            .attr( "height", height );

    var svgCongressMap = d3.select( "body" )
            .append( "svg" )
            .attr( "id", "ncSenMap")
            .attr( "width", width )
            .attr( "height", height );

    var svgHB2Map = d3.select( "body" )
            .append( "svg" )
            .attr( "id", "ncSenMap")
            .attr( "width", width )
            .attr( "height", height );

    var gr = d3.select("#map").append( "g" ).attr("id", "repMap");
//    var gs = svgSenMap.append( "g" );
    var gs = d3.select("#map").append( "g" ).attr("id", "senMap");
//    var gCon = svgCongressMap.append( "g" );
    var gc = d3.select("#map").append( "g" ).attr("id", "conMap");
    var ghb2 = svgHB2Map.append( "g" );

    var albersProjection = d3.geo.albersUsa()
            .scale(7000)
//            .rotate( [71.057,0] )
//            .center( [0, 42.313] )
            .translate( [-1200, -40] );

    var geoPath = d3.geo.path()
            .projection( albersProjection );

    var republicanColor = "#DB1F1E";
    var selectedRepublicanColor = "#DB1F1E";
    var democratColor = "#1840DE";
    var selectedDemocratColor = "#";
    var independentColor = "#AAADAD";
    var selectedIndependentColor = "#";
    var selectedColor = "#07C230";

    var photoHiResURL = "http://www.ncga.state.nc.us/House/pictures/hiRes/719.jpg";

    function getThumbnailURL(url, house) {
        var lastSlashIndex = url.indexOf("hiRes") + 6;
        var fileName = url.substr(lastSlashIndex);
        var thumbnailURL = "http://www.ncga.state.nc.us/" + house + "/pictures/" + fileName;
        return thumbnailURL;
    }

    function toggleMap(map) {
        if (map == "rep") {
            document.getElementById("senMap").style.display = "none";
            document.getElementById("conMap").style.display = "none";
            document.getElementById("legTitle").innerHTML = "Representative";
            document.getElementById("repMap").style.display = "block";
        }
        else if (map == "sen") {

            document.getElementById("conMap").style.display = "none";
            document.getElementById("repMap").style.display = "none";
            document.getElementById("legTitle").innerHTML = "Senator";
            document.getElementById("senMap").style.display = "block";
        }
        else if (map == "con") {
            document.getElementById("senMap").style.display = "none";
            document.getElementById("repMap").style.display = "none";
            document.getElementById("legTitle").innerHTML = "Representative (DC)";
            document.getElementById("conMap").style.display = "block";

        }
    }

    function parseDistrictString(district) {
        var lastDigit = district.slice(-1);
        var suffix = "";
        if (lastDigit == 0 || lastDigit >= 4 ) {
            suffix = "th";
        }
        else if (lastDigit == 3) {
            suffix = "rd";
        }
        else if (lastDigit == 2) {
            suffix = "nd";
        }
        else {
            suffix = "st";
        }
        return district + suffix;
    }

    function parseAddress(address) {
        if (address.indexOf("N.C. House") != -1) {
            var repLoc = address.indexOf('ves') + 3;
//            address[repLoc] = "<br>";
            address = address.substr(0, repLoc) + "<br>" + address.substr(repLoc + 1);
            return address;
        }
        else if (address.indexOf("N.C. Senate") != -1) {
            var senateLoc = address.indexOf('ate') + 3;
//            address[firstComma] = "<br>";
            address = address.substr(0, senateLoc) + "<br>" + address.substr(senateLoc + 1);
            return address;
        }
        else {
            var firstComma = address.indexOf(',');
            var secondComma = address.ind
//            address[firstComma] = "<br>";
            address = address.substr(0, firstComma) + "<br>" + address.substr(firstComma + 1);
            return address;
        }
    }
//    console.log(ncCongressReps);
//    d3.json("ncsgeo/ncrepdistrictsmin.json", function (json) {
//        console.log(json);
//        gr.selectAll("path")
//                .data(json.features)
//                .enter()
//                .append("path")
//                .attr("fill", "#ffffff")
//                .attr("stroke", "#888888")
//                .each(function(d, i) {
//                    var district = d.properties.District;
//                    d3.select(this)
//                        .attr("id", "d" + district)
//                        .attr("onmouseover", 'd3.select(d' + district + ').attr("fill", "' + democratColor + '")')
//                        .attr("onclick", "console.log(" + district + ")")
//                        .attr("onmouseout", 'd3.select(d' + district + ').attr("fill", "#ffffff")');
//            })
//                .attr("d", geoPath);
//    });

//    d3.json("ncsgeo/ncsendistrictsmin.json", function (json) {
//        console.log(json);
//        gs.selectAll("path")
//                .data(json.features)
//                .enter()
//                .append("path")
//                .attr("fill", "#ffffff")
//                .attr("stroke", "#888888")
//                .each(function(d, i) {
//                    var district = d.properties.District;
//                    d3.select(this)
//                            .attr("id", "s" + district)
//                            .attr("onmouseover", 'd3.select(s' + district + ').attr("fill", "' + democratColor + '")')
//                            .attr("onclick", "console.log(" + district + ")")
//                            .attr("onmouseout", 'd3.select(s' + district + ').attr("fill", "#ffffff")');
//                })
//                .attr("d", geoPath);
//    });

//    d3.json("ncsgeo/ncdccongressdistrictsmin.json", function (json) {
//        console.log(json);
//        cg.selectAll("path")
//                .data(json.features)
//                .enter()
//                .append("path")
//                .attr("fill", "#ffffff")
//                .attr("stroke", "#888888")
//                .each(function(d, i) {
//                    var district = d.properties.District;
//                    d3.select(this)
//                            .attr("id", "con" + district)
//                            .attr("onmouseover", 'd3.select(con' + district + ').attr("fill", "' + democratColor + '")')
//                            .attr("onclick", "console.log(" + district + ")")
//                            .attr("onmouseout", 'd3.select(con' + district + ').attr("fill", "#ffffff")');
//                })
//                .attr("d", geoPath);
//    });

    function getPartyColor(partyString) {
        var republicanColor = "#DB1F1E";
        var selectedRepublicanColor = "#DB1F1E";
        var democratColor = "#1840DE";
        var selectedDemocratColor = "#";
        var independentColor = "#AAADAD";
        var selectedIndependentColor = "#";
        var selectedColor = "#07C230";
        if (partyString == "D" || partyString == "Democrat" || partyString == "Democratic") {
            return democratColor;
        }
        else if (partyString == "R" || partyString == "Republican") {
            return republicanColor;
        }
        else {
            return independentColor;
        }
    }

    function displayRepData(rep) {
        document.getElementById("repNameText").innerHTML = rep.fullName;
        document.getElementById("emailLink").innerHTML = rep.email;
        document.getElementById("emailLink").href = rep.email;
        document.getElementById("districtText").innerHTML = parseDistrictString(rep.district) + " District<br>";
        document.getElementById("partyText").innerHTML = rep.party;
        document.getElementById("nclegURLText").innerHTML = "Represenative's NC Legislature Page";
        document.getElementById("nclegURLText").href = rep.ncLegURL;
        document.getElementById("repPhoto").src = getThumbnailURL(rep.photoURL, "House");
        var localPhone = rep.offices[0].phone != null ? "Phone: " + rep.offices[0].phone : "";
        var capitalPhone = rep.offices[1].phone != null ? "Phone: " + rep.offices[1].phone : "";
        document.getElementById("localAddress").innerHTML = rep.offices[0].name + "<br><br>" + parseAddress(rep.offices[0].address) + "<br>" + localPhone;
        document.getElementById("capitalAddress").innerHTML = rep.offices[1].name + "<br><br>" + parseAddress(rep.offices[1].address) + "<br>Phone: " + rep.offices[1].phone;
    }

    function displaySenData(sen) {
        document.getElementById("repNameText").innerHTML = sen.fullName;
        document.getElementById("emailLink").innerHTML = sen.email;
        document.getElementById("emailLink").href = sen.email;
        document.getElementById("districtText").innerHTML = sen.district;
        document.getElementById("partyText").innerHTML = sen.party;
        document.getElementById("nclegURLText").innerHTML = "Senator's NC Legislature Page";
        document.getElementById("nclegURLText").href = sen.ncLegURL;
        document.getElementById("repPhoto").src = getThumbnailURL(sen.photoURL, "Senate");
        var localPhone = sen.offices[0].phone != null ? "Phone: " + sen.offices[0].phone : "";
        var capitalPhone = sen.offices[1].phone != null ? "Phone: " + sen.offices[1].phone : "";
        document.getElementById("localAddress").innerHTML = sen.offices[0].name + "<br><br>" + parseAddress(sen.offices[0].address) + "<br>" + localPhone;
        document.getElementById("capitalAddress").innerHTML = sen.offices[1].name + "<br><br>" + parseAddress(sen.offices[1].address) + "<br>" + capitalPhone;
    }

    function displaySenData(sen) {
        document.getElementById("repNameText").innerHTML = sen.fullName;
        document.getElementById("emailLink").innerHTML = sen.email;
        document.getElementById("emailLink").href = sen.email;
        document.getElementById("districtText").innerHTML = sen.district;
        document.getElementById("partyText").innerHTML = sen.party;
        document.getElementById("nclegURLText").innerHTML = "Senator's NC Legislature Page";
        document.getElementById("nclegURLText").href = sen.ncLegURL;
        document.getElementById("repPhoto").src = getThumbnailURL(sen.photoURL, "Senate");
        var localPhone = sen.offices[0].phone != null ? "Phone: " + sen.offices[0].phone : "";
        var capitalPhone = sen.offices[1].phone != null ? "Phone: " + sen.offices[1].phone : "";
        document.getElementById("localAddress").innerHTML = sen.offices[0].name + "<br><br>" + parseAddress(sen.offices[0].address) + "<br>" + localPhone;
        document.getElementById("capitalAddress").innerHTML = sen.offices[1].name + "<br><br>" + parseAddress(sen.offices[1].address) + "<br>" + capitalPhone;
    }

    function drawRepMap() {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                var repJSON = JSON.parse(this.responseText);
                var repModel = {};
                console.log(repJSON);
                repJSON.forEach(function(rep){
                    repModel[rep.district] = {
                        "party": rep.party,
                        "fullName": rep.full_name,
                        "id": rep.leg_id,
                        "level": rep.level,
                        "offices": rep.offices,
                        "photoURL": rep.photo_url,
                        "ncLegURL": rep.url,
                        "email": rep.email,
                        "chamber": rep.chamber,
                        "active": rep.active,
                        "district": rep.district,
                        "nimspCandID": rep.nimsp_candidate_id,
                        "nimspID": rep.nimsp_id
                    };

                });
                d3.json("ncsgeo/ncrepdistrictsmin.json", function (json) {
                    gr.selectAll("path")
                            .data(json.features)
                            .enter()
                            .append("path")
                            .attr("stroke", "#222222")
                            .each(function(d, i) {
                                var district = d.properties.District;
//                                console.log(repModel[district])
                                d3.select(this)
                                        .attr("id", "r" + district)
                                        .attr("fill", getPartyColor(repModel[district].party))
                                        .attr("onmouseover", 'd3.select(r' + district + ').attr("fill", "' + selectedColor + '")')
                                        .attr("onmouseout", 'd3.select(r' + district + ').attr("fill", "' + getPartyColor(repModel[district].party) + '")');
                                document.getElementById("r" + district).onclick = function(){displayRepData(repModel[district])};

                            })
                            .attr("d", geoPath);
                });
            }
        };
        xhttp.open("GET", ncRepURL, true);
        xhttp.send();
    }
    drawRepMap();

    function drawSenMap() {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                var senJSON = JSON.parse(this.responseText);
                var senModel = {};
                senJSON.forEach(function(sen){
                    senModel[sen.district] = {
                        "party": sen.party,
                        "fullName": sen.full_name,
                        "id": sen.leg_id,
                        "level": sen.level,
                        "offices": sen.offices,
                        "photoURL": sen.photo_url,
                        "ncLegURL": sen.url,
                        "email": sen.email,
                        "chamber": sen.chamber,
                        "active": sen.active,
                        "district": sen.district,
                        "nimspCandID": sen.nimsp_candidate_id,
                        "nimspID": sen.nimsp_id
                    };
                });

                d3.json("ncsgeo/ncsendistrictsmin.json", function (json) {
                    console.log(json);
                    gs.selectAll("path")
                            .data(json.features)
                            .enter()
                            .append("path")
//                            .attr("fill", "#888888")
                            .attr("stroke", "#000000")
                            .each(function(d, i) {
                                var district = d.properties.District;
                                d3.select(this)
                                        .attr("id", "s" + district)
                                        .attr("fill", getPartyColor(senModel[district].party))
                                        .attr("onmouseover", 'd3.select(s' + district + ').attr("fill", "' + selectedColor + '")')
                                        .attr("onmouseout", 'd3.select(s' + district + ').attr("fill", "' + getPartyColor(senModel[district].party) + '")');
                                document.getElementById("s" + district).onclick = function(){displaySenData(senModel[district])};
//                                        .attr("onmouseout", 'd3.select(s' + district + ').attr("fill", "#ffffff")');
                            })
                            .attr("d", geoPath);
                });
            }
        };
        xhttp.open("GET", ncSenateURL, true);
        xhttp.send();
    }
    drawSenMap();

    function drawConMap() {
        var repCongressModel = {};
        ncCongressReps.results.forEach(function(rep){
            repCongressModel[rep.district] = {
                "party": rep.party,
                "rep": rep.first_name + " " + rep.last_name,
                "gender": rep.gender,
                "title": rep.gender == "M" ? "Congressman":"Congresswoman",
                "website": rep.url,
                "facebook": rep.facebook_account,
                "fax": rep.fax,
                "phone": rep.phone,
                "twitter": rep.twitter_account,
                "youtube": rep.youtube_account,
                "district": rep.district,
                "id": rep.id
            };
        });
        console.log(ncCongressReps.results);
        d3.json("ncsgeo/ncdccongressdistrictsmin.json", function (json) {
            gc.selectAll("path")
                    .data(json.features)
                    .enter()
                    .append("path")
                    .attr("stroke", "#222222")
                    .each(function(d, i) {
                        var district = d.properties.District;
                        d3.select(this)
                                .attr("id", "c" + district)
                                .attr("fill", getPartyColor(repCongressModel[district].party))
//                              .attr("onmouseover", 'd3.select(d' + district + ').attr("fill", "' + democratColor + '")')
                              .attr("onclick", "console.log('" + repCongressModel[district].rep + "')")
                                .attr("onmouseover", 'd3.select(c' + district + ').attr("fill", "' + selectedColor + '")')
                              .attr("onmouseout", 'd3.select(c' + district + ').attr("fill", "' + getPartyColor(repCongressModel[district].party) + '")');
//                              .attr("onmouseout", 'd3.select(d' + district + ').attr("fill", "#ffffff")');
                    })
                    .attr("d", geoPath);
        });
    }

    drawConMap();

</script>
</body>
</html>